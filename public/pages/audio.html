<template>
    <div class="page page-homepage light" data-name="homepage">
        <div class="navbar">
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="back">
                        <i class="icon icon-back mr-3 ml-3"></i>
                        <span class="if-not-md">Back</span>
                    </a>
                </div>
                <div class="title" style="text-align: center;">Audio</div>
                <div class="right">
                    <a class="popover-open mr-2" data-popover=".popover-menu-bantuan" style="padding-left: 10px;">
                        <i class="material-icons">more_vert</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content ptr-content" data-ptr-mousewheel="false" @ptr:refresh="ptr1" @ptr:pullstart="start1">
            <div class="ptr-preloader" id="ptr1" style="display: none;">
                <div class="preloader"></div>
                <div class="ptr-arrow"></div>
            </div>
            <div class="block px-2">
                <div class="block-title" style="margin-left: 5px;">Audio Feature</div>
                <div class="card demo-card-header-pic">
                    <!-- <div class="card-content"> <img src="https://cdn.framework7.io/placeholder/nature-1000x700-8.jpg" width="100%"/></div> -->
                    <div class="card-content card-content-padding">
                        <p class="date">Posted on January 21, 2015</p>
                        <p>WebViewGold memungkinkan kita bisa memutar suara dari bermacam bentuk file audio.</p>
                            <button onclick="startRecording(this);" class="col button button-fill button-raised color-default mb-0  mx-0">record</button>
                            <br>
                            <button onclick="stopRecording(this);" class="col button button-fill button-raised color-default mb-0  mx-0" disabled>stop</button>

                        <h2>Recordings</h2>
                        <ul id="recordingslist"></ul>

                        <h2>Log</h2>
                        <pre id="log"></pre>
                    </div>
                </div>
            </div>
        </div>


    </div>
</template>
<script>
    function __log(e, data) {
        log.innerHTML += "\n" + e + " " + (data || '');
    }

    var audio_context;
    var recorder;

    function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        __log('Media stream created.');

        // Uncomment if you want the audio to feedback directly
        //input.connect(audio_context.destination);
        //__log('Input connected to audio context destination.');

        recorder = new Recorder(input);
        __log('Recorder initialised.');
    }

    function createDownloadLink() {
        recorder && recorder.exportWAV(function (blob) {
            var url = URL.createObjectURL(blob);
            var li = document.createElement('li');
            var au = document.createElement('audio');
            var hf = document.createElement('a');

            au.controls = true;
            au.src = url;
            hf.href = url;
            hf.download = new Date().toISOString() + '.wav';
            hf.innerHTML = hf.download;
            li.appendChild(au);
            li.appendChild(hf);
            recordingslist.appendChild(li);
        });
    }

    window.onload = function init() {
        try {
            // webkit shim
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
            window.URL = window.URL || window.webkitURL;

            audio_context = new AudioContext;
            __log('Audio context set up.');
            __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
        } catch (e) {
            alert('No web audio support in this browser!');
        }

        navigator.getUserMedia({
            audio: true
        }, startUserMedia, function (e) {
            __log('No live audio input: ' + e);
        });
    };

    var hari = new Date();
    var namaHari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    var monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober',
        'November', 'Desember'
    ];
    return {
        data: function () {
            return {
                tanggal: namaHari[hari.getDay()] + ', ' + hari.getDate() + ' ' + monthNames[hari.getMonth()] + ' ' +
                    hari.getFullYear(),
                loading: true,
            }
        },
        methods: {
            stopRecording: function () {
                recorder && recorder.stop();
                button.disabled = true;
                button.previousElementSibling.disabled = false;
                __log('Stopped recording.');
                // create WAV download link using audio data blob
                createDownloadLink();
                recorder.clear();
            },
            startRecording: function () {
                recorder && recorder.record();
                button.disabled = true;
                button.nextElementSibling.disabled = false;
                __log('Recording...');
            },
            ptr1: function (e, done) {
                var self = this;
                var $ = self.$$;
                self.$setState({
                    loading: true
                });
                setTimeout(function () {
                    self.$setState({
                        loading: false
                    });
                    $("#ptr1").hide();
                }, 1000); // refresh done

                setTimeout(function () {
                    self.$setState({
                        items: self.items,
                    });
                    // Done
                    done();
                }, 600);
                this.Halaman;
            },
            start1: function () {
                $("#ptr1").show();
            },
            halAwal: function () {
                var self = this;
                var app = self.$app;
                var $ = self.$;

                setTimeout(function () {
                    self.$setState({
                        loading: false
                    });
                }, 600);
            }
        },
        on: {
            pageInit: function (e, page) {
                this.halAwal()
            },
        }

    }
</script>